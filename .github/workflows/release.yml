name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.0'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 'c82f74667287d3dc386bce81e44964370c91a289'

      - name: Install dependencies
        run: vcpkg install openssl:x64-windows argon2:x64-windows gtest:x64-windows

      - name: Build
        run: |
          cd Projects/FileEncryption
          cmake -B build `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
          cmake --build build --config Release

      - name: Test
        run: |
          cd Projects/FileEncryption
          ctest --test-dir build -C Release --output-on-failure

      - name: Deploy
        run: |
          cd Projects/FileEncryption
          mkdir deploy
          
          # Copy executable
          copy build\Release\FileEncryption.exe deploy\
          
          # Deploy Qt dependencies
          & "$env:QT_ROOT_DIR\bin\windeployqt.exe" `
            --no-translations `
            --no-system-d3d-compiler `
            --no-opengl-sw `
            deploy\FileEncryption.exe
          
          # Copy OpenSSL DLLs
          copy "$env:VCPKG_ROOT\installed\x64-windows\bin\libcrypto-3-x64.dll" deploy\
          copy "$env:VCPKG_ROOT\installed\x64-windows\bin\libssl-3-x64.dll" deploy\
          
          # Copy Argon2 DLL
          copy "$env:VCPKG_ROOT\installed\x64-windows\bin\argon2.dll" deploy\
          
          # Create ZIP archive
          Compress-Archive -Path deploy\* -DestinationPath FileEncryption-Windows-x64.zip
          
          # List contents
          Get-ChildItem deploy -Recurse | Format-Table Name, Length

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: Projects/FileEncryption/FileEncryption-Windows-x64.zip
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
